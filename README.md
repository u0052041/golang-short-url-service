# Short URL Service

é«˜æ€§èƒ½çŸ­ç¶²å€æœå‹™ï¼Œä½¿ç”¨ Go æ§‹å»ºï¼Œæ”¯æŒ Redis ç·©å­˜å’Œ PostgreSQL æŒä¹…åŒ–å­˜å„²ã€‚

## åŠŸèƒ½ç‰¹é»

- ğŸš€ **é«˜æ€§èƒ½**: åŸºæ–¼ Gin æ¡†æ¶ï¼Œæ”¯æŒé«˜ä¸¦ç™¼è«‹æ±‚
- ğŸ’¾ **é›™å±¤å­˜å„²**: Redis ç·©å­˜ + PostgreSQL æŒä¹…åŒ–
- ğŸ”’ **é€Ÿç‡é™åˆ¶**: åŸºæ–¼ Redis çš„åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶
- ğŸ³ **å®¹å™¨åŒ–**: å®Œæ•´çš„ Docker Compose éƒ¨ç½²æ–¹æ¡ˆ
- âš¡ **Nginx åå‘ä»£ç†**: è² è¼‰å‡è¡¡ã€Gzip å£“ç¸®ã€å®‰å…¨ Headers
- ğŸ“Š **è¨ªå•çµ±è¨ˆ**: è¨˜éŒ„é»æ“Šæ¬¡æ•¸å’Œè¨ªå•æ—¥èªŒ

## ç³»çµ±æ¶æ§‹

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Client    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚    Nginx    â”‚
                    â”‚  (Port 80)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚            â”‚            â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
        â”‚  Go API   â”‚ â”‚ Go API  â”‚ â”‚  Go API   â”‚
        â”‚ Instance 1â”‚ â”‚Instance2â”‚ â”‚ Instance Nâ”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚            â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Redis   â”‚           â”‚  PostgreSQL   â”‚
        â”‚  (Cache)  â”‚           â”‚ (Persistent)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿé–‹å§‹

### å‰ç½®éœ€æ±‚

- Docker Engine 20.10+
- Docker Compose 2.0+

### å•Ÿå‹•æœå‹™

1. **è¤‡è£½ç’°å¢ƒè®Šæ•¸æ–‡ä»¶**

```bash
cp env.local .env
```

2. **ç·¨è¼¯é…ç½®**ï¼ˆå¯é¸ï¼‰

```bash
vim .env
```

> æ³¨æ„ï¼š`docker-compose.yml` ä¸å†æä¾› PostgreSQL é è¨­å¯†ç¢¼ï¼Œè«‹å‹™å¿…åœ¨ `.env` è¨­å®š `POSTGRES_PASSWORD`ï¼Œé¿å…ä½¿ç”¨å¼±å¯†ç¢¼èª¤ä¸Šç·šã€‚

3. **å•Ÿå‹•æ‰€æœ‰æœå‹™**

```bash
docker-compose up -d
```

4. **æŸ¥çœ‹æœå‹™ç‹€æ…‹**

```bash
docker-compose ps
```

5. **æŸ¥çœ‹æ—¥èªŒ**

```bash
docker-compose logs -f
```

### é–‹ç™¼æ¨¡å¼

ä½¿ç”¨é–‹ç™¼é…ç½®å•Ÿå‹•ï¼ˆæš´éœ²æ•¸æ“šåº«ç«¯å£ï¼‰ï¼š

```bash
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
```

## API æ–‡æª”

### OpenAPI / Swaggerï¼ˆæ¨è–¦ï¼‰

æœ¬å°ˆæ¡ˆæä¾›ä¸€ä»½ OpenAPI è¦æ ¼æª”ï¼š`api/openapi.yaml`ï¼Œå¯ç”¨æ–¼ Swagger UI / Postman / Insomnia åŒ¯å…¥èˆ‡ç¶­è­·ï¼›README åªä¿ç•™æœ€å¸¸ç”¨çš„å¿«é€Ÿç¯„ä¾‹ã€‚

**ç”¨ Swagger UI æœ¬åœ°é è¦½ï¼ˆéœ€è¦ Dockerï¼‰**ï¼š

```bash
docker run --rm -p 8081:8080 \
  -e SWAGGER_JSON=/spec/openapi.yaml \
  -v "$(pwd)/api/openapi.yaml:/spec/openapi.yaml:ro" \
  swaggerapi/swagger-ui
```

ç„¶å¾Œæ‰“é–‹ `http://localhost:8081`ã€‚

### ç«¯é»ä¸€è¦½ï¼ˆåƒ…åˆ—è·¯ç”±ï¼Œæ ¼å¼ä»¥ OpenAPI ç‚ºæº–ï¼‰

- `POST /api/v1/shorten`
- `GET /api/v1/stats/{code}`
- `GET /{code}`ï¼ˆ301 redirectï¼‰
- `GET /health`
- `GET /health/detailed`

## ç’°å¢ƒè®Šæ•¸

| è®Šæ•¸ | èªªæ˜ | é è¨­å€¼ |
|------|------|--------|
| `APP_ENV` | é‹è¡Œç’°å¢ƒ (production/development) | production |
| `APP_PORT` | æ‡‰ç”¨ç«¯å£ | 8080 |
| `APP_BASE_URL` | çŸ­ç¶²å€åŸºç¤ URL | http://localhost |
| `POSTGRES_HOST` | PostgreSQL ä¸»æ©Ÿ | postgres |
| `POSTGRES_PORT` | PostgreSQL ç«¯å£ | 5432 |
| `POSTGRES_USER` | PostgreSQL ç”¨æˆ¶ | shorturl |
| `POSTGRES_PASSWORD` | PostgreSQL å¯†ç¢¼ | shorturl_secret |
| `POSTGRES_DB` | PostgreSQL æ•¸æ“šåº« | shorturl |
| `REDIS_HOST` | Redis ä¸»æ©Ÿ | redis |
| `REDIS_PORT` | Redis ç«¯å£ | 6379 |
| `REDIS_PASSWORD` | Redis å¯†ç¢¼ | (ç©º) |
| `RATE_LIMIT_REQUESTS` | æ¯åˆ†é˜è«‹æ±‚é™åˆ¶ | 100 |
| `RATE_LIMIT_DURATION` | é™åˆ¶æ™‚é–“çª—å£ | 1m |

## é …ç›®çµæ§‹

```
golang-short-url-service/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ main.go              # æ‡‰ç”¨å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config.go            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â””â”€â”€ handler.go           # HTTP è™•ç†å™¨
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ ratelimit.go         # é€Ÿç‡é™åˆ¶
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â””â”€â”€ url.go               # æ•¸æ“šæ¨¡å‹
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ postgres.go          # PostgreSQL æ“ä½œ
â”‚   â”‚   â””â”€â”€ redis.go             # Redis æ“ä½œ
â”‚   â””â”€â”€ service/
â”‚       â””â”€â”€ shorturl.go          # æ¥­å‹™é‚è¼¯
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 001_init.sql             # æ•¸æ“šåº«åˆå§‹åŒ–
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ nginx.conf               # Nginx ä¸»é…ç½®
â”‚   â””â”€â”€ conf.d/
â”‚       â””â”€â”€ default.conf         # ç«™é»é…ç½®
â”œâ”€â”€ docker/
â”‚   â””â”€â”€ Dockerfile               # å¤šéšæ®µæ§‹å»º
â”œâ”€â”€ docker-compose.yml           # ç”Ÿç”¢ç’°å¢ƒ
â”œâ”€â”€ docker-compose.dev.yml       # é–‹ç™¼ç’°å¢ƒ
â”œâ”€â”€ env.local                  # ç’°å¢ƒè®Šæ•¸ç¯„æœ¬
â”œâ”€â”€ go.mod
â””â”€â”€ README.md
```

## çŸ­ç¢¼ç”Ÿæˆç®—æ³•

ä½¿ç”¨ PostgreSQL BIGSERIAL è‡ªå¢ ID + Base62 ç·¨ç¢¼ï¼š

```
ID: 1      â†’ çŸ­ç¢¼: "000001"
ID: 62     â†’ çŸ­ç¢¼: "000010"
ID: 1000   â†’ çŸ­ç¢¼: "0000g8"
ID: 100000 â†’ çŸ­ç¢¼: "000q0U"
```

Base62 å­—ç¬¦é›†: `0-9A-Za-z`

## æ€§èƒ½å„ªåŒ–

### é»æ“Šè¨ˆæ•¸ç­–ç•¥

æ¡ç”¨ **Redis INCR + å®šæœŸæ‰¹æ¬¡åŒæ­¥** ç­–ç•¥ï¼Œå¤§å¹…æ¸›å°‘è³‡æ–™åº«å¯«å…¥å£“åŠ›ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     INCR      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Request   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚    Redis    â”‚
â”‚  (é»æ“Šäº‹ä»¶)  â”‚               â”‚ clicks:xxx  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                              æ¯å°æ™‚åŒæ­¥ä¸€æ¬¡
                                     â”‚
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ PostgreSQL  â”‚
                              â”‚ click_count â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å·¥ä½œæµç¨‹ï¼š**
1. æ¯æ¬¡é»æ“Šæ™‚ï¼Œä½¿ç”¨ `Redis INCR` åŸå­æ“ä½œç´¯åŠ è¨ˆæ•¸
2. å¾Œå° Scheduler æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡æ‰¹æ¬¡åŒæ­¥
3. åŒæ­¥æ™‚ä½¿ç”¨ `GETDEL` åŸå­ç²å–ä¸¦æ¸…é™¤ Redis è¨ˆæ•¸
4. æ‰¹é‡æ›´æ–°åˆ° PostgreSQL
5. å„ªé›…é—œé–‰æ™‚æœƒåŸ·è¡Œæœ€çµ‚åŒæ­¥ï¼Œç¢ºä¿æ•¸æ“šä¸ä¸Ÿå¤±

**å„ªé»ï¼š**
- é«˜ä¸¦ç™¼ä¸‹ Redis INCR æ€§èƒ½æ¥µä½³
- æ¸›å°‘ 99% ä»¥ä¸Šçš„è³‡æ–™åº«å¯«å…¥
- æŸ¥è©¢çµ±è¨ˆæ™‚è‡ªå‹•åˆä½µ DB + Redis å¾…åŒæ­¥æ•¸æ“š

### Redis ç·©å­˜ç­–ç•¥

- ç†±é–€ URL ç·©å­˜ TTL: 1 å°æ™‚
- ç·©å­˜æœªå‘½ä¸­æ™‚å¾ PostgreSQL è®€å–ä¸¦å›å¡«
- é»æ“Šè¨ˆæ•¸ä½¿ç”¨ç¨ç«‹ key (`clicks:{shortCode}`)

### æ•¸æ“šåº«é€£æ¥æ± 

- æœ€å¤§é€£æ¥æ•¸: 25
- æœ€å°é€£æ¥æ•¸: 5
- é€£æ¥æœ€å¤§ç”Ÿå‘½é€±æœŸ: 1 å°æ™‚

### Nginx å„ªåŒ–

- Gzip å£“ç¸®
- Keep-alive é€£æ¥
- è«‹æ±‚ç·©è¡
- è² è¼‰å‡è¡¡ (least_conn)

## ç”Ÿç”¢éƒ¨ç½²å»ºè­°

### å®‰å…¨æ€§

1. **æ›´æ”¹é»˜èªå¯†ç¢¼**
   ```bash
   # ç”Ÿæˆå¼·å¯†ç¢¼
   openssl rand -base64 32
   ```

2. **å•Ÿç”¨ HTTPS**
   - åœ¨ Nginx é…ç½® SSL è­‰æ›¸
   - ä½¿ç”¨ Let's Encrypt å…è²»è­‰æ›¸

3. **é™åˆ¶æ•¸æ“šåº«è¨ªå•**
   - ä¸è¦æš´éœ² PostgreSQL/Redis ç«¯å£åˆ°å…¬ç¶²


### æ°´å¹³æ“´å±•

ä¿®æ”¹ `docker-compose.yml` æ·»åŠ æ›´å¤š API å¯¦ä¾‹ï¼š

```yaml
services:
  api:
    deploy:
      replicas: 3
```

## å¸¸ç”¨å‘½ä»¤

```bash
# å•Ÿå‹•æœå‹™
docker-compose up -d

# åœæ­¢æœå‹™
docker-compose down

# æŸ¥çœ‹æ—¥èªŒ
docker-compose logs -f api

# é‡å»ºé¡åƒ
docker-compose build --no-cache

# é€²å…¥å®¹å™¨
docker exec -it shorturl-api sh

# é€£æ¥æ•¸æ“šåº«
docker exec -it shorturl-postgres psql -U shorturl -d shorturl

# é€£æ¥ Redis
docker exec -it shorturl-redis redis-cli
```

## è¨±å¯è­‰

MIT License


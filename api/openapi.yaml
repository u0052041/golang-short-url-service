openapi: 3.0.3
info:
  title: Short URL Service API
  description: |
    高性能短網址服務 API（Gin + Redis + PostgreSQL）。
    本檔案為 OpenAPI 規格，可用於 Swagger UI / Postman / Insomnia 匯入。
  version: 1.0.0
servers:
  - url: http://localhost
    description: Local (default)
tags:
  - name: ShortURL
    description: 短網址建立與查詢
  - name: Redirect
    description: 短網址重定向
  - name: Health
    description: 健康檢查

paths:
  /api/v1/shorten:
    post:
      tags: [ShortURL]
      summary: 建立短網址
      description: |
        建立短網址。若相同 URL 曾經被建立且仍有效，會回傳既有短碼。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateURLRequest'
            examples:
              default:
                value:
                  url: https://example.com/very/long/url/path
                  expires_in: 7d
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateURLResponse'
        '400':
          description: Bad Request（JSON body 無效或欄位驗證失敗）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_request:
                  value:
                    error: invalid_request
                    message: Invalid request body: ...
        '429':
          description: Too Many Requests（速率限制）
          headers:
            X-RateLimit-Limit:
              schema: { type: string }
            X-RateLimit-Remaining:
              schema: { type: string }
            X-RateLimit-Reset:
              schema: { type: string }
            Retry-After:
              schema: { type: string }
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                rate_limited:
                  value:
                    error: rate limit exceeded
                    message: Too many requests. Please try again later.
        '200':
          description: 內部錯誤（依需求不回 500，改回 200 + ErrorResponse）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                internal_error:
                  value:
                    error: internal_error
                    message: Failed to create short URL

  /api/v1/stats/{code}:
    get:
      tags: [ShortURL]
      summary: 取得短網址統計
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
          description: 短碼
      responses:
        '200':
          description: OK（成功時回 URLStatsResponse；內部錯誤時回 ErrorResponse）
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/URLStatsResponse'
                  - $ref: '#/components/schemas/ErrorResponse'
        '400':
          description: Bad Request（code 空值）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    error: not_found
                    message: Short URL not found
        '429':
          description: Too Many Requests（速率限制）
          headers:
            X-RateLimit-Limit:
              schema: { type: string }
            X-RateLimit-Remaining:
              schema: { type: string }
            X-RateLimit-Reset:
              schema: { type: string }
            Retry-After:
              schema: { type: string }
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        # 依需求：不回 500，內部錯誤改回 200，schema 已包含於 200 的 oneOf

  /{code}:
    get:
      tags: [Redirect]
      summary: 短網址重定向
      description: 成功時回傳 301 並在 Location header 放原始 URL。
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
          description: 短碼
      responses:
        '301':
          description: Moved Permanently
          headers:
            Location:
              schema:
                type: string
              description: 原始 URL
        '400':
          description: Bad Request（code 空值）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  value:
                    error: not_found
                    message: Short URL not found
        '410':
          description: Gone（短網址已過期）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                expired:
                  value:
                    error: expired
                    message: This short URL has expired
        '429':
          description: Too Many Requests（速率限制）
          headers:
            X-RateLimit-Limit:
              schema: { type: string }
            X-RateLimit-Remaining:
              schema: { type: string }
            X-RateLimit-Reset:
              schema: { type: string }
            Retry-After:
              schema: { type: string }
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '200':
          description: 內部錯誤（依需求不回 500，改回 200 + ErrorResponse）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /health:
    get:
      tags: [Health]
      summary: 健康檢查
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                required: [status]

  /health/detailed:
    get:
      tags: [Health]
      summary: 詳細健康檢查（內部用途）
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  postgres:
                    type: string
                    example: connected
                  redis:
                    type: string
                    example: connected
                required: [status, postgres, redis]

components:
  schemas:
    CreateURLRequest:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: 原始 URL
        expires_in:
          type: string
          description: |
            可選：過期時間（例：`24h`, `7d`, `30d`）。
            不提供則不過期（或由服務端預設策略決定）。
      required: [url]

    CreateURLResponse:
      type: object
      properties:
        short_code:
          type: string
          description: 短碼
          example: 0000g8
        short_url:
          type: string
          description: 完整短網址
          example: http://localhost/0000g8
        original_url:
          type: string
          format: uri
          description: 原始 URL
        expires_at:
          type: string
          format: date-time
          description: 過期時間（RFC3339），若無則不回傳
      required: [short_code, short_url, original_url]

    URLStatsResponse:
      type: object
      properties:
        short_code:
          type: string
        original_url:
          type: string
          format: uri
        click_count:
          type: integer
          format: int64
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          description: 若無則不回傳
        is_active:
          type: boolean
      required: [short_code, original_url, click_count, created_at, is_active]

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: 錯誤代碼/原因
        message:
          type: string
          description: 錯誤訊息
      required: [error, message]

